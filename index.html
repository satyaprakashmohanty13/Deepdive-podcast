<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloud Music Stream - Spotify Style</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Custom scrollbar for a more Spotify-like feel */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #282828; /* Darker track */
        }
        ::-webkit-scrollbar-thumb {
            background: #535353; /* Dark gray thumb */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #727272; /* Lighter gray on hover */
        }
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            overflow: hidden; /* Prevent body scroll, main content will scroll */
            background-color: #000; /* Spotify black background */
            color: #b3b3b3; /* Light gray text */
        }
        /* Hide default audio controls for the hidden player */
        audio::-webkit-media-controls-panel {
            display: none !important;
            -webkit-appearance: none;
        }
        audio::-webkit-media-controls-play-button,
        audio::-webkit-media-controls-current-time-display,
        audio::-webkit-media-controls-time-remaining-display,
        audio::-webkit-media-controls-timeline,
        audio::-webkit-media-controls-volume-slider {
            display: none !important;
            -webkit-appearance: none;
        }
        /* Custom styling for the range input (progress bar and volume slider) */
        input[type="range"] {
            -webkit-appearance: none; /* Override default appearance */
            appearance: none;
            background: transparent; /* Hide default track */
            cursor: pointer;
        }
        input[type="range"]::-webkit-slider-runnable-track {
            background: #404040; /* Dark gray track */
            border-radius: 5px;
            height: 4px;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; /* Override default appearance */
            appearance: none;
            height: 12px;
            width: 12px;
            background-color: #1DB954; /* Spotify green thumb */
            border-radius: 50%;
            margin-top: -4px; /* Center thumb vertically */
            box-shadow: 0 0 2px rgba(0, 0, 0, 0.5);
        }
        input[type="range"]:hover::-webkit-slider-thumb {
            background-color: #1ED760; /* Lighter green on hover */
        }
        input[type="range"]::-moz-range-track {
            background: #404040;
            border-radius: 5px;
            height: 4px;
        }
        input[type="range"]::-moz-range-thumb {
            height: 12px;
            width: 12px;
            background-color: #1DB954;
            border-radius: 50%;
            box-shadow: 0 0 2px rgba(0, 0, 0, 0.5);
        }
        input[type="range"]:hover::-moz-range-thumb {
            background-color: #1ED760;
        }
    </style>
</head>
<body class="flex flex-col h-screen">

    <!-- Main layout: Sidebar + Main Content -->
    <div class="flex flex-1 overflow-hidden">

        <!-- Sidebar -->
        <!-- Hidden on small screens by default, toggled by JS, visible on medium and larger screens -->
        <aside id="sidebar" class="w-64 bg-black text-white p-4 flex-col hidden md:flex">
            <!-- Spotify Logo (Placeholder) -->
            <div class="mb-8 mt-2">
                <img src="https://placehold.co/120x40/000000/1DB954?text=Spotify" alt="Spotify Logo" class="h-10">
            </div>

            <!-- Navigation Links -->
            <nav class="space-y-4">
                <a href="#" id="nav-home" class="flex items-center text-lg font-semibold text-white hover:text-gray-300 transition-colors rounded-md p-2">
                    <i class="fas fa-home text-2xl mr-4"></i> Home
                </a>
                <a href="#" class="flex items-center text-lg font-semibold text-white hover:text-gray-300 transition-colors rounded-md p-2">
                    <i class="fas fa-search text-2xl mr-4"></i> Search
                </a>
                <a href="#" id="nav-library" class="flex items-center text-lg font-semibold text-white hover:text-gray-300 transition-colors rounded-md p-2">
                    <i class="fas fa-book text-2xl mr-4"></i> Your Library
                </a>
            </nav>

            <!-- Playlists Section -->
            <div class="mt-8">
                <h3 class="text-md font-bold text-gray-400 mb-4 uppercase tracking-wider">Playlists</h3>
                <ul class="space-y-2 text-sm">
                    <li><a href="#" id="playlist-my-top-songs" class="block text-gray-400 hover:text-white transition-colors rounded-md p-1">My Top Songs</a></li>
                    <li><a href="#" id="playlist-discover-weekly" class="block text-gray-400 hover:text-white transition-colors rounded-md p-1">Discover Weekly</a></li>
                    <li><a href="#" id="playlist-liked-songs" class="block text-gray-400 hover:text-white transition-colors rounded-md p-1">Liked Songs</a></li>
                    <li><a href="#" id="playlist-workout-mix" class="block text-gray-400 hover:text-white transition-colors rounded-md p-1">Workout Mix</a></li>
                </ul>
            </div>
        </aside>

        <!-- Main Content Area -->
        <!-- The pb-24 class adds padding to the bottom to prevent content from being hidden by the fixed player bar -->
        <main class="flex-1 bg-gradient-to-b from-gray-900 to-black p-6 overflow-y-auto pb-24">
            <!-- Top Bar (for navigation and user actions) -->
            <div class="flex justify-between items-center mb-8">
                <div class="flex items-center space-x-4">
                    <!-- Hamburger menu for mobile -->
                    <button id="mobile-menu-button" class="bg-black text-white p-2 rounded-full hover:bg-gray-800 transition-colors md:hidden">
                        <i class="fas fa-bars"></i>
                    </button>
                    <!-- Navigation buttons -->
                    <button class="bg-black text-white p-2 rounded-full hover:bg-gray-800 transition-colors hidden md:block">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <button class="bg-black text-white p-2 rounded-full hover:bg-gray-800 transition-colors hidden md:block">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
                <div class="flex items-center space-x-4">
                    <!-- User action buttons -->
                    <button class="bg-white text-black px-4 py-2 rounded-full font-bold text-sm hover:scale-105 transition-transform">Sign Up</button>
                    <button class="bg-gray-800 text-white px-4 py-2 rounded-full font-bold text-sm hover:bg-gray-700 transition-colors">Log In</button>
                </div>
            </div>

            <!-- Home View -->
            <div id="home-view" class="active-view">
                <!-- Search Bar for Home View -->
                <div class="mb-8">
                    <input type="text" id="home-search-input" placeholder="What do you want to listen to?" class="w-full p-3 rounded-full bg-gray-800 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-green-500">
                </div>

                <!-- Main Sections - "Good evening" -->
                <section class="mb-10">
                    <h2 class="text-3xl font-bold text-white mb-6">Good evening</h2>
                    <!-- Playlist Container - where fetched songs will be displayed -->
                    <div id="playlist" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">
                        <!-- Loading State -->
                        <div id="loading" class="col-span-full text-center py-10">
                            <p class="text-xl text-gray-400">Loading your music...</p>
                        </div>
                        <!-- Error Message Container -->
                        <div id="error-message" class="hidden col-span-full bg-red-800 border border-red-600 text-red-200 px-4 py-3 rounded-lg relative" role="alert">
                            <strong class="font-bold">Oops!</strong>
                            <span class="block sm:inline">Something went wrong while fetching the music.</span>
                        </div>
                    </div>
                </section>

                <!-- Placeholder for other sections (e.g., "Your top mixes") -->
                <section class="mb-10">
                    <h2 class="text-3xl font-bold text-white mb-6">Your top mixes</h2>
                    <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">
                        <!-- Example Cards for demonstration -->
                        <div class="relative bg-gray-800 p-3 rounded-lg shadow-lg hover:bg-gray-700 transition-colors cursor-pointer group">
                            <img src="https://placehold.co/100x100/1DB954/FFFFFF?text=Mix+1" alt="Daily Mix 1 Album Art" class="w-full h-auto rounded-md mb-2 shadow-md">
                            <h3 class="text-base font-semibold text-white truncate">Daily Mix 1</h3>
                            <p class="text-xs text-gray-400">Chill beats for your morning</p>
                            <!-- Play button overlay on hover -->
                            <button class="absolute bottom-12 right-4 bg-green-500 text-black p-2 rounded-full shadow-lg opacity-0 group-hover:opacity-100 group-hover:translate-y-0 translate-y-2 transition-all duration-300 ease-in-out">
                                <i class="fas fa-play text-sm"></i>
                            </button>
                             <!-- Three-dot menu for example cards -->
                            <button class="absolute top-3 right-3 text-gray-400 hover:text-white p-1 rounded-full">
                                <i class="fas fa-ellipsis-h"></i>
                            </button>
                        </div>
                        <div class="relative bg-gray-800 p-3 rounded-lg shadow-lg hover:bg-gray-700 transition-colors cursor-pointer group">
                            <img src="https://placehold.co/100x100/E91E63/FFFFFF?text=Mix+2" alt="Workout Jams Album Art" class="w-full h-auto rounded-md mb-2 shadow-md">
                            <h3 class="text-base font-semibold text-white truncate">Workout Jams</h3>
                            <p class="text-xs text-gray-400">High energy for your workout</p>
                            <button class="absolute bottom-12 right-4 bg-green-500 text-black p-2 rounded-full shadow-lg opacity-0 group-hover:opacity-100 group-hover:translate-y-0 translate-y-2 transition-all duration-300 ease-in-out">
                                <i class="fas fa-play text-sm"></i>
                            </button>
                             <!-- Three-dot menu for example cards -->
                            <button class="absolute top-3 right-3 text-gray-400 hover:text-white p-1 rounded-full">
                                <i class="fas fa-ellipsis-h"></i>
                            </button>
                        </div>
                    </div>
                </section>
            </div>

            <!-- Your Library View (Initially hidden) -->
            <div id="library-view" class="hidden">
                <h2 class="text-3xl font-bold text-white mb-6">Your Library</h2>
                <!-- Search Bar for Library View -->
                <div class="mb-8">
                    <input type="text" id="library-search-input" placeholder="Search in your library..." class="w-full p-3 rounded-full bg-gray-800 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-green-500">
                </div>
                <div id="library-playlist" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">
                    <p class="col-span-full text-center text-gray-400" id="empty-library-message">Your library is empty. Add some songs!</p>
                </div>
            </div>
        </main>
    </div>

    <!-- Bottom Player Bar - Fixed at the bottom of the viewport -->
    <div id="player-bar" class="fixed bottom-0 left-0 right-0 bg-gray-900 h-24 flex items-center justify-between px-6 z-50">
        <!-- Current Song Info -->
        <div class="flex items-center space-x-4 w-1/3 min-w-0">
            <img id="current-song-album-art" src="https://placehold.co/60x60/1DB954/FFFFFF?text=Album" alt="Album Art" class="w-16 h-16 rounded-md shadow-md flex-shrink-0">
            <div class="flex flex-col min-w-0">
                <p id="current-song-title" class="text-white font-semibold text-lg truncate">Not Playing</p>
                <p id="current-song-artist" class="text-gray-400 text-sm truncate">Select a song</p>
            </div>
        </div>

        <!-- Player Controls -->
        <div class="flex flex-col items-center justify-center w-1/3 max-w-xl">
            <div class="flex items-center space-x-6 mb-2">
                <button class="text-gray-400 hover:text-white text-xl"><i class="fas fa-random"></i></button>
                <button id="previous-button" class="text-gray-400 hover:text-white text-xl"><i class="fas fa-step-backward"></i></button>
                <button id="play-pause-button" class="bg-white text-black p-3 rounded-full text-xl hover:scale-105 transition-transform">
                    <i class="fas fa-play"></i>
                </button>
                <button id="next-button" class="text-gray-400 hover:text-white text-xl"><i class="fas fa-step-forward"></i></button>
                <button class="text-gray-400 hover:text-white text-xl"><i class="fas fa-redo"></i></button>
            </div>
            <!-- Progress Bar -->
            <div class="flex items-center w-full max-w-md space-x-2">
                <span id="current-time" class="text-xs text-gray-400">0:00</span>
                <input type="range" id="progress-bar" value="0" min="0" max="100" class="flex-1 h-1 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-green-500">
                <span id="duration" class="text-xs text-gray-400">0:00</span>
            </div>
        </div>

        <!-- Volume and Other Controls -->
        <div class="flex items-center justify-end space-x-4 w-1/3">
            <button class="text-gray-400 hover:text-white text-xl hidden sm:block"><i class="fas fa-microphone"></i></button>
            <button class="text-gray-400 hover:text-white text-xl hidden sm:block"><i class="fas fa-list"></i></button>
            <button class="text-gray-400 hover:text-white text-xl"><i class="fas fa-volume-up"></i></button>
            <input type="range" id="volume-slider" value="100" min="0" max="100" class="w-24 h-1 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-green-500 hidden sm:block">
        </div>
    </div>

    <!-- Hidden Audio Player - Used for actual playback -->
    <audio id="hidden-audio-player" class="hidden"></audio>

    <!-- Toast Notification Container -->
    <div id="toast-container" class="fixed bottom-28 right-6 z-50 space-y-2">
        <!-- Toasts will be appended here -->
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const playlistContainer = document.getElementById('playlist'); // Home view playlist
            const libraryPlaylistContainer = document.getElementById('library-playlist'); // Library view playlist
            const emptyLibraryMessage = document.getElementById('empty-library-message');
            const loadingIndicator = document.getElementById('loading');
            const errorMessage = document.getElementById('error-message');
            const hiddenAudioPlayer = document.getElementById('hidden-audio-player');
            const playPauseButton = document.getElementById('play-pause-button');
            const progressBar = document.getElementById('progress-bar');
            const currentTimeSpan = document.getElementById('current-time');
            const durationSpan = document.getElementById('duration');
            const volumeSlider = document.getElementById('volume-slider');
            const currentSongTitle = document.getElementById('current-song-title');
            const currentSongArtist = document.getElementById('current-song-artist');
            const currentSongAlbumArt = document.getElementById('current-song-album-art');
            const nextButton = document.getElementById('next-button');
            const previousButton = document.getElementById('previous-button');
            const mobileMenuButton = document.getElementById('mobile-menu-button');
            const sidebar = document.getElementById('sidebar');
            const homeSearchInput = document.getElementById('home-search-input');
            const librarySearchInput = document.getElementById('library-search-input');
            const navHome = document.getElementById('nav-home');
            const navLibrary = document.getElementById('nav-library');
            const homeView = document.getElementById('home-view');
            const libraryView = document.getElementById('library-view');
            const toastContainer = document.getElementById('toast-container');

            // Playlist specific elements
            const playlistMyTopSongs = document.getElementById('playlist-my-top-songs');
            const playlistDiscoverWeekly = document.getElementById('playlist-discover-weekly');
            const playlistLikedSongs = document.getElementById('playlist-liked-songs');
            const playlistWorkoutMix = document.getElementById('playlist-workout-mix');


            let allSongs = []; // Stores all fetched songs from API
            let userLibrarySongs = []; // Stores songs added to user's library
            let currentSongIndex = -1; // Index of the currently playing song in `allSongs`
            let currentActiveView = 'home'; // Tracks which view is currently active ('home' or 'library')

            // Array of vibrant colors for album art placeholders
            const albumArtColors = [
                '1DB954', // Spotify Green
                'E91E63', // Pink
                '9C27B0', // Purple
                '2196F3', // Blue
                'FFC107', // Amber
                'FF5722', // Deep Orange
                '00BCD4', // Cyan
                '8BC34A', // Light Green
                'FFEB3B', // Yellow
                '607D8B', // Blue Grey
                'F44336', // Red
                '4CAF50', // Green
                'FF9800', // Orange
                '673AB7', // Deep Purple
                '03A9F4'  // Light Blue
            ];

            // --- IMPORTANT ---
            // Replace this URL with the URL of your deployed serverless function.
            // If you are developing locally with the Vercel CLI, this will be http://localhost:3000/api/music
            const API_ENDPOINT = '/api/music'; // This works when deployed on Vercel

            /**
             * Shows a temporary toast notification.
             * @param {string} message - The message to display.
             * @param {string} type - 'success' or 'info' for styling.
             */
            function showToast(message, type = 'info') {
                const toast = document.createElement('div');
                toast.className = `px-4 py-2 rounded-lg shadow-md text-white text-sm transition-opacity duration-300 ease-out ${type === 'success' ? 'bg-green-600' : 'bg-gray-700'}`;
                toast.textContent = message;
                toastContainer.appendChild(toast);

                setTimeout(() => {
                    toast.style.opacity = '0';
                    toast.addEventListener('transitionend', () => toast.remove());
                }, 3000); // Toast disappears after 3 seconds
            }

            /**
             * Fetches music data from the API endpoint.
             * Displays loading indicator and handles errors.
             */
            async function fetchMusic() {
                try {
                    const response = await fetch(API_ENDPOINT);
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    allSongs = await response.json(); // Store fetched songs globally
                    
                    // Hide loading indicator once data is fetched
                    loadingIndicator.style.display = 'none';
                    
                    // Display all fetched songs initially in the home view
                    displaySongs(allSongs, playlistContainer, 'home');

                } catch (error) {
                    console.error('Failed to fetch music:', error);
                    // Hide loading indicator and show error message on failure
                    loadingIndicator.style.display = 'none';
                    errorMessage.classList.remove('hidden');
                }
            }

            /**
             * Displays the given songs as Spotify-like cards in the specified container.
             * @param {Array<Object>} songsToDisplay - An array of song objects to display.
             * @param {HTMLElement} container - The DOM element where songs should be displayed.
             * @param {string} viewType - 'home' or 'library' to determine card behavior.
             */
            function displaySongs(songsToDisplay, container, viewType) {
                if (!songsToDisplay || songsToDisplay.length === 0) {
                    container.innerHTML = `<p class="col-span-full text-center text-gray-400">No songs found matching your criteria.</p>`;
                    // Show empty message only for library view if it's truly empty
                    if (viewType === 'library') {
                        emptyLibraryMessage.classList.remove('hidden');
                    }
                    return;
                }
                if (viewType === 'library') {
                    emptyLibraryMessage.classList.add('hidden');
                }

                // Clear any existing content
                container.innerHTML = '';

                songsToDisplay.forEach((song, index) => {
                    // Find the original index of the song in `allSongs` for consistent album art color and playback
                    const originalSongIndex = allSongs.findIndex(s => s.secure_url === song.secure_url);
                    const albumArtBgColor = albumArtColors[originalSongIndex % albumArtColors.length];

                    // Create the card element for each song
                    const songCard = document.createElement('div');
                    songCard.className = 'relative bg-gray-800 p-3 rounded-lg shadow-lg hover:bg-gray-700 transition-colors cursor-pointer group';
                    
                    // Create Album Art image
                    const albumArt = document.createElement('img');
                    albumArt.src = `https://placehold.co/100x100/${albumArtBgColor}/FFFFFF?text=${encodeURIComponent(song.title.substring(0, Math.min(song.title.length, 5)))}`; 
                    albumArt.alt = song.title;
                    albumArt.className = 'w-full h-auto rounded-md mb-2 shadow-md';
                    albumArt.onerror = () => albumArt.src = `https://placehold.co/100x100/${albumArtBgColor}/FFFFFF?text=Album`; 

                    // Create Song Title element
                    const titleElement = document.createElement('h3');
                    titleElement.className = 'text-base font-semibold text-white truncate';
                    titleElement.textContent = song.title;

                    // Create Artist element (Placeholder)
                    const artistElement = document.createElement('p');
                    artistElement.className = 'text-xs text-gray-400 truncate';
                    artistElement.textContent = 'Unknown Artist'; // Replace with actual artist if available

                    // Create Play Button Overlay
                    const playButtonOverlay = document.createElement('button');
                    playButtonOverlay.className = 'absolute bottom-12 right-4 bg-green-500 text-black p-2 rounded-full shadow-lg opacity-0 group-hover:opacity-100 group-hover:translate-y-0 translate-y-2 transition-all duration-300 ease-in-out';
                    playButtonOverlay.innerHTML = '<i class="fas fa-play text-sm"></i>';

                    // Create Three-dot menu button - NOW ALWAYS VISIBLE
                    const threeDotButton = document.createElement('button');
                    threeDotButton.className = 'absolute top-3 right-3 text-gray-400 hover:text-white p-1 rounded-full'; // Removed opacity classes
                    threeDotButton.innerHTML = '<i class="fas fa-ellipsis-h"></i>';

                    // Create dropdown for "Add to Library" option
                    const dropdown = document.createElement('div');
                    dropdown.className = 'absolute top-10 right-3 bg-gray-700 text-white rounded-md shadow-lg p-2 text-sm z-10 hidden';
                    
                    const addLibOption = document.createElement('button');
                    addLibOption.className = 'block w-full text-left px-3 py-2 hover:bg-gray-600 rounded-md';
                    addLibOption.textContent = 'Add to Your Library';
                    dropdown.appendChild(addLibOption);

                    // Check if song is already in library to update button text/state
                    const isAlreadyInLibrary = userLibrarySongs.some(libSong => libSong.secure_url === song.secure_url);
                    if (isAlreadyInLibrary) {
                        addLibOption.textContent = 'Added to Library';
                        addLibOption.disabled = true;
                        addLibOption.classList.add('opacity-50', 'cursor-not-allowed');
                    }

                    // Append all elements to the song card
                    songCard.appendChild(albumArt);
                    songCard.appendChild(titleElement);
                    songCard.appendChild(artistElement);
                    songCard.appendChild(playButtonOverlay);
                    songCard.appendChild(threeDotButton);
                    songCard.appendChild(dropdown); // Append dropdown to card

                    container.appendChild(songCard);

                    // Event listener to play the song
                    songCard.addEventListener('click', (e) => {
                        // Only play if not clicking the three-dot button or dropdown
                        if (!threeDotButton.contains(e.target) && !dropdown.contains(e.target)) {
                            playSong(originalSongIndex);
                        }
                    });
                    playButtonOverlay.addEventListener('click', (e) => {
                        e.stopPropagation(); // Prevent the card's click event from firing simultaneously
                        playSong(originalSongIndex);
                    });

                    // Event listener for three-dot button to toggle dropdown
                    threeDotButton.addEventListener('click', (e) => {
                        e.stopPropagation(); // Prevent card click and other clicks
                        dropdown.classList.toggle('hidden');
                        // Close other dropdowns
                        document.querySelectorAll('.song-card-dropdown').forEach(openDropdown => {
                            if (openDropdown !== dropdown) {
                                openDropdown.classList.add('hidden');
                            }
                        });
                    });

                    // Event listener for "Add to Your Library" option
                    addLibOption.addEventListener('click', (e) => {
                        e.stopPropagation();
                        if (!addLibOption.disabled) {
                            addSongToLibrary(song);
                            dropdown.classList.add('hidden'); // Hide dropdown after click
                            addLibOption.textContent = 'Added to Library';
                            addLibOption.disabled = true;
                            addLibOption.classList.add('opacity-50', 'cursor-not-allowed');
                        }
                    });

                    // Hide dropdown if clicked outside
                    document.addEventListener('click', (e) => {
                        if (!songCard.contains(e.target)) {
                            dropdown.classList.add('hidden');
                        }
                    });
                });
            }

            /**
             * Adds a song to the user's local library.
             * @param {Object} song - The song object to add.
             */
            function addSongToLibrary(song) {
                // Check if the song is already in the library
                const isAlreadyAdded = userLibrarySongs.some(libSong => libSong.secure_url === song.secure_url);

                if (!isAlreadyAdded) {
                    userLibrarySongs.push(song);
                    saveLibraryToLocalStorage();
                    showToast('Song added to library!', 'success');
                    // If currently in library view, refresh it to show the new song
                    if (currentActiveView === 'library') {
                        displaySongs(userLibrarySongs, libraryPlaylistContainer, 'library');
                    }
                } else {
                    showToast('Song already in library!', 'info');
                }
            }

            /**
             * Loads user's library from localStorage.
             */
            function loadLibraryFromLocalStorage() {
                try {
                    const storedLibrary = localStorage.getItem('userLibrarySongs');
                    if (storedLibrary) {
                        userLibrarySongs = JSON.parse(storedLibrary);
                    }
                } catch (e) {
                    console.error("Failed to load library from local storage:", e);
                    userLibrarySongs = [];
                }
            }

            /**
             * Saves user's library to localStorage.
             */
            function saveLibraryToLocalStorage() {
                try {
                    localStorage.setItem('userLibrarySongs', JSON.stringify(userLibrarySongs));
                } catch (e) {
                    console.error("Failed to save library to local storage:", e);
                }
            }

            /**
             * Plays a song based on its index in the allSongs array and updates the player bar UI.
             * @param {number} index - The index of the song to play in the allSongs array.
             */
            function playSong(index) {
                if (index < 0 || index >= allSongs.length) {
                    console.error('Invalid song index:', index);
                    return;
                }

                const song = allSongs[index];
                if (!song) {
                    console.error('Song not found at index:', index);
                    return;
                }

                // If a new song is selected or the current one is different, load and play
                if (hiddenAudioPlayer.src !== song.secure_url) {
                    hiddenAudioPlayer.src = song.secure_url;
                    currentSongIndex = index; // Update the current song index
                    currentSongTitle.textContent = song.title;
                    currentSongArtist.textContent = 'Unknown Artist'; // Placeholder
                    // Update album art in the player bar with the correct color
                    const albumArtBgColor = albumArtColors[currentSongIndex % albumArtColors.length];
                    currentSongAlbumArt.src = `https://placehold.co/60x60/${albumArtBgColor}/FFFFFF?text=${encodeURIComponent(song.title.substring(0, Math.min(song.title.length, 3)))}`; 
                    hiddenAudioPlayer.play();
                    playPauseButton.innerHTML = '<i class="fas fa-pause"></i>'; // Change icon to pause
                } else if (hiddenAudioPlayer.paused) {
                    // If the same song is paused, resume playback
                    hiddenAudioPlayer.play();
                    playPauseButton.innerHTML = '<i class="fas fa-pause"></i>'; // Change icon to pause
                } else {
                    // If the same song is playing, pause it
                    hiddenAudioPlayer.pause();
                    playPauseButton.innerHTML = '<i class="fas fa-play"></i>'; // Change icon to play
                }
            }

            // Event listener for the main play/pause button in the player bar
            playPauseButton.addEventListener('click', () => {
                if (hiddenAudioPlayer.src) { // Only toggle if a song URL is loaded
                    if (hiddenAudioPlayer.paused) {
                        hiddenAudioPlayer.play();
                        playPauseButton.innerHTML = '<i class="fas fa-pause"></i>';
                    } else {
                        hiddenAudioPlayer.pause();
                        playPauseButton.innerHTML = '<i class="fas fa-play"></i>';
                    }
                } else if (allSongs.length > 0) {
                    // If no song is loaded but songs are available, play the first one
                    playSong(0);
                }
            });

            // Event listener for the next song button
            nextButton.addEventListener('click', () => {
                if (allSongs.length === 0) return; // No songs to play

                let nextIndex = currentSongIndex + 1;
                if (nextIndex >= allSongs.length) {
                    nextIndex = 0; // Loop back to the first song
                }
                playSong(nextIndex);
            });

            // Event listener for the previous song button
            previousButton.addEventListener('click', () => {
                if (allSongs.length === 0) return; // No songs to play

                let prevIndex = currentSongIndex - 1;
                if (prevIndex < 0) {
                    prevIndex = allSongs.length - 1; // Loop back to the last song
                }
                playSong(prevIndex);
            });

            // Update progress bar and current time as song plays
            hiddenAudioPlayer.addEventListener('timeupdate', () => {
                if (!isNaN(hiddenAudioPlayer.duration)) { // Ensure duration is a valid number
                    const progress = (hiddenAudioPlayer.currentTime / hiddenAudioPlayer.duration) * 100;
                    progressBar.value = progress;
                    currentTimeSpan.textContent = formatTime(hiddenAudioPlayer.currentTime);
                }
            });

            // Update total duration when song metadata is loaded
            hiddenAudioPlayer.addEventListener('loadedmetadata', () => {
                if (!isNaN(hiddenAudioPlayer.duration)) {
                    durationSpan.textContent = formatTime(hiddenAudioPlayer.duration);
                }
            });

            // When song ends, play the next one
            hiddenAudioPlayer.addEventListener('ended', () => {
                nextButton.click(); // Simulate a click on the next button
            });

            // Seek functionality: when user drags the progress bar
            progressBar.addEventListener('input', () => {
                if (!isNaN(hiddenAudioPlayer.duration)) {
                    const seekTime = (progressBar.value / 100) * hiddenAudioPlayer.duration;
                    hiddenAudioPlayer.currentTime = seekTime;
                }
            });

            // Volume control: when user drags the volume slider
            volumeSlider.addEventListener('input', () => {
                hiddenAudioPlayer.volume = volumeSlider.value / 100;
            });

            /**
             * Formats time in seconds into a "minutes:seconds" string (e.g., 3:05).
             * @param {number} seconds - The time in seconds.
             * @returns {string} The formatted time string.
             */
            function formatTime(seconds) {
                const minutes = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${minutes}:${secs < 10 ? '0' : ''}${secs}`;
            }

            // Mobile menu toggle functionality
            mobileMenuButton.addEventListener('click', () => {
                sidebar.classList.toggle('hidden'); // Toggle hidden class
                sidebar.classList.toggle('flex'); // Toggle flex class
            });

            // Home View Search functionality
            homeSearchInput.addEventListener('input', () => {
                const query = homeSearchInput.value.toLowerCase().trim();
                if (query === '') {
                    displaySongs(allSongs, playlistContainer, 'home'); // Show all songs if search is empty
                } else {
                    const filteredSongs = allSongs.filter(song => 
                        song.title.toLowerCase().includes(query)
                    );
                    displaySongs(filteredSongs, playlistContainer, 'home'); // Display only matching songs
                }
            });

            // Library View Search functionality
            librarySearchInput.addEventListener('input', () => {
                const query = librarySearchInput.value.toLowerCase().trim();
                if (query === '') {
                    displaySongs(userLibrarySongs, libraryPlaylistContainer, 'library'); // Show all library songs
                } else {
                    const filteredLibrarySongs = userLibrarySongs.filter(song => 
                        song.title.toLowerCase().includes(query)
                    );
                    displaySongs(filteredLibrarySongs, libraryPlaylistContainer, 'library'); // Display matching library songs
                }
            });

            // Navigation between Home and Library views
            function showView(viewName) {
                homeView.classList.add('hidden');
                libraryView.classList.add('hidden');
                document.getElementById(`${viewName}-view`).classList.remove('hidden');
                currentActiveView = viewName;

                // If switching to library, refresh its display
                if (viewName === 'library') {
                    displaySongs(userLibrarySongs, libraryPlaylistContainer, 'library');
                    librarySearchInput.value = ''; // Clear library search on view switch
                } else {
                    homeSearchInput.value = ''; // Clear home search on view switch
                    displaySongs(allSongs, playlistContainer, 'home'); // Refresh home view
                }
            }

            navHome.addEventListener('click', (e) => {
                e.preventDefault();
                showView('home');
            });

            navLibrary.addEventListener('click', (e) => {
                e.preventDefault();
                showView('library');
            });

            /**
             * Filters and displays songs based on playlist criteria.
             * @param {string} playlistType - The type of playlist ('my-top-songs', 'discover-weekly', 'liked-songs', 'workout-mix').
             */
            function filterAndDisplayPlaylist(playlistType) {
                let filteredSongs = [];
                homeSearchInput.value = ''; // Clear search input when a playlist is selected
                showView('home'); // Always switch to home view for playlists

                switch (playlistType) {
                    case 'my-top-songs':
                        filteredSongs = allSongs; // Display all songs for "My Top Songs"
                        break;
                    case 'discover-weekly':
                        filteredSongs = allSongs.filter(song => song.title.startsWith('*'));
                        break;
                    case 'liked-songs':
                        filteredSongs = allSongs.filter(song => song.title.startsWith('#'));
                        break;
                    case 'workout-mix':
                        filteredSongs = allSongs.filter(song => /^\d/.test(song.title)); // Starts with a digit
                        break;
                    default:
                        filteredSongs = allSongs;
                        break;
                }
                displaySongs(filteredSongs, playlistContainer, 'home');
            }

            // Event listeners for playlists
            playlistMyTopSongs.addEventListener('click', (e) => {
                e.preventDefault();
                filterAndDisplayPlaylist('my-top-songs');
            });

            playlistDiscoverWeekly.addEventListener('click', (e) => {
                e.preventDefault();
                filterAndDisplayPlaylist('discover-weekly');
            });

            playlistLikedSongs.addEventListener('click', (e) => {
                e.preventDefault();
                filterAndDisplayPlaylist('liked-songs');
            });

            playlistWorkoutMix.addEventListener('click', (e) => {
                e.preventDefault();
                filterAndDisplayPlaylist('workout-mix');
            });


            // Initial calls
            loadLibraryFromLocalStorage(); // Load library on start
            fetchMusic(); // Fetch all songs
            showView('home'); // Show home view by default
        });
    </script>

</body>
</html>
